# Физическое хранение данных цифрового рубля

## База данных
- **СУБД**: PostgreSQL 14+
- **Развертывание**: Primary-Replica кластер (Patroni + HAProxy), 3 ноды.

## Табличные пространства (Tablespaces)
- **hot_data** (SSD, NVMe): 
  - client
  - digital_wallet
  - bank_account
  - instruction
  - cbdc_transaction
  - auto_payment
- **archive_data** (HDD, S3 для долгосрочного хранения архивов):
  - исторические данные (транзакции старше 2 лет, логи интеграций)

## Партиционирование
- Таблица **cbdc_transaction**:
  - Партиция по timestamp (месячная), чтобы оптимизировать производительность и быстрое удаление старых данных.
- Таблица **instruction**:
  - Аналогично партиционированию транзакций по created_at.

## Индексы
- Индексы по foreign key полям (client_id, wallet_id, instruction_id)
- Композитные индексы для часто встречающихся выборок и аналитики:
  - Например, cbdc_transaction(from_wallet_id, to_wallet_id, timestamp)

## Репликация и резервное копирование
- Репликация: асинхронная, задержка реплик не более 500 мс.
- Backup policy:
  - полные бэкапы — еженочно;
  - WAL incremental — каждые 10 минут;
  - хранение бэкапов — 14 дней локально, 60 дней S3.

## Мониторинг и производительность
- Метрики PostgreSQL собираются через Prometheus + Grafana:
  - Время выполнения запросов не должно превышать 100 ms (99% запросов).
- Alerting через Alertmanager:
  - превышение threshold (>100ms SELECT, >200ms UPDATE/INSERT).

## Аудит и логирование
- Отдельная таблица integration_logs для XML-сообщений обмена с платформой ЦБ.
- Логирование всех изменений в критичных таблицах (транзакции, инструкции) через триггеры.


# Правила валидации перед отправкой сообщений на платформу ЦР

Перед отправкой сообщений в платформу цифрового рубля обязательно проведение следующих проверок на стороне банка-посредника:

---

## Проверка клиента (KYC)

- `Client.kyc_status = VERIFIED`
- `Client.is_blocked = false`

Если условия не выполнены, транзакция отклоняется до отправки.

---

## Проверка лимитов операций

| Операция              | Лимиты и правила проверок                              |
|-----------------------|--------------------------------------------------------|
| Пополнение (DEPOSIT)  | Баланс банковского счёта ≥ сумма операции              |
| Вывод (WITHDRAW)      | Баланс цифрового кошелька ≥ сумма операции             |
| Перевод (TRANSFER)    | Баланс кошелька ≥ сумма операции (или offlineLimit при оффлайн-транзакции) |

При нарушении условий лимитов транзакция не отправляется на платформу ЦР.

---

## Проверка расписания автоплатежей

Автоплатёж проверяется на актуальность даты исполнения (`next_payment ≤ текущая дата`).

---

## Проверка уникальности сообщений

- Сообщение проверяется по полю `MsgId` на уникальность перед отправкой.
- Если дубликат — транзакция отклоняется, регистрируется событие.

---

## Структурная проверка XML-сообщений (по XSD-схемам)

Обязательная проверка перед отправкой:

- XML-сообщение соответствует одной из утверждённых XSD-схем (`cbdc.002`, `cbdc.050`, `cbdc.051`, `cbdc.777`).
- Сообщение содержит все необходимые поля (MsgId, InstrId, OprId, кошельки, суммы и пр.).

---

## Дополнительные проверки (AML/CFT)

- Если клиент включен в списки мониторинга AML/CFT (`ClientAMLCFT`), транзакция блокируется до отдельного подтверждения.
- Информирование оператора AML/CFT при выявлении подозрительных операций.

---

## Обработка нарушений

- Любое нарушение правил блокирует отправку транзакции.
- Логирование в журнал событий (`integration_logs`) с указанием причины отказа.
- Оповещение ответственного сотрудника в случае критических нарушений (например, AML).

---

## Инструменты для реализации проверок

- Сервис KYC банка
- Сервис управления лимитами
- Сервис AML/CFT контроля
- Валидаторы XML-сообщений (XSD-based validators)

Эти проверки обеспечивают соответствие нормативам, минимизацию ошибок и стабильность работы с платформой цифрового рубля.

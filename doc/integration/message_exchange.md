# Описание взаимодействия по XML API (интеграция с платформой ЦР)

## Общий процесс взаимодействия

Взаимодействие между банком (финансовым посредником, ФП) и платформой цифрового рубля Банка России (ЦР) осуществляется через обмен электронными сообщениями (ЭС) в формате XML, стандарта ISO 20022.

---

## Типы используемых сообщений и форматы

| Тип операции                         | Запрос (ФП→ЦР)                 | Ответ (ЦР→ФП)                  | Уведомления клиенту          |
|--------------------------------------|--------------------------------|--------------------------------|------------------------------|
| Пополнение кошелька (bank → CBDC)    | `cbdc.002 PaymentInstruction`  | `cbdc.051 MessageStatusResponse` | `OpTransferToDCARecipientNotification` |
| Вывод с кошелька (CBDC → bank)       | `cbdc.002 PaymentInstruction`  | `cbdc.051 MessageStatusResponse` | `OpTransferToBankSenderNotification` |
| Перевод (кошелек → кошелек)          | `cbdc.002 PaymentInstruction`  | `cbdc.051 MessageStatusResponse` | `DCTransferC2CRecipientNotification`, `DCTransferC2CSenderNotification` |
| Покупка ЦР организацией              | —                              | —                              | `OrganisationDCBuyingFINotification`, `OrganisationDCBuyingNotification` |
| Продажа ЦР организацией              | —                              | —                              | `OrganisationDCSellingFINotification`, `OrganisationDCSellingNotification` |

---

## Процесс обмена сообщениями (Workflow):

1. **Создание инструкции**
   - Клиент формирует поручение через мобильное приложение или интернет-банк.
   - Backend банка создаёт запись (`Instruction`) и формирует XML-запрос (`cbdc.002`).

2. **Отправка XML-запроса**
   - Backend подписывает сообщение (ГОСТ TLS) и передаёт через интеграционный слой на ПлЦР.
   - Фиксируется уникальный идентификатор сообщения (`MsgId`) и операции (`InstrId`).

3. **Получение и обработка ответа**
   - Платформа ЦР возвращает статус обработки в XML-ответе (`cbdc.051`).
   - Банк проверяет статус:  
     - `PRCD` (успех) → обновляет статус инструкции (`CONFIRMED`), создаёт транзакцию (`CBDCTransaction`).
     - `RJCT` (отказ) → обновляет статус инструкции (`ERROR`), фиксирует причину отказа.

4. **Уведомления клиентов**
   - При успешном исполнении отправляются уведомления клиентам согласно XSD (`cbdc.777`).

---

## Обработка ошибок и исключений

| Статус ошибки | Действия банка |
|---------------|----------------|
| RJCT (отказ ЦР) | Фиксирование ошибки, информирование клиента, отмена списания средств |
| Дублирование сообщения | Проверка по `MsgId`, если повтор — отказ в обработке |
| Некорректная структура XML | Ошибка валидации, сообщение не отправляется, логирование ошибки |

---

## Технические особенности интеграции:

- **Протокол передачи**: HTTPS (ГОСТ TLS).
- **Формат сообщений**: XML (ISO 20022).
- **Методы защиты**: ЭЦП, шифрование, контроль целостности.
- **Сервис валидации**: автоматическая проверка по XSD-схемам перед отправкой.